// bootstrap
import Accordion from 'react-bootstrap/Accordion';
import Tab from "react-bootstrap/Tab";
import Tabs from "react-bootstrap/Tabs"
import Badge from 'react-bootstrap/Badge';
import Row from 'react-bootstrap/Row';
import Col from 'react-bootstrap/Col';
import Container from 'react-bootstrap/Container';
import Button from 'react-bootstrap/Button';
import VulnerabilityDetails from './VulnerabilityDetails';
import { useRef, useState } from 'react';
import { Buffer } from 'buffer';

import SecurityAdvisory from "../../models/advisory/SecurityAdvisory";
import Spinner from 'react-bootstrap/esm/Spinner';

function VulnerabilityAccordion({ vulnerabilities, whitelist, dependencies, ipfs }) {
    const loadedAdvisories = useRef([{cid: "", advisory: {}}]);
    const [selectedVulnerabilities, setSelectedVulnerabilities] = useState([]);

    const [loading, setLoading] = useState(true);
    const startLoading = () => setLoading(true); 
    const stopLoading = () => setLoading(false);

    /**
     * Function used to select and download the advisories for the selected vulnerability.
     * @param {[]} vulnerabilities 
     */
    async function selectVulnerabilities(vulnerabilities) {
        let updatedVulnerabilities = [];
        for await (let vulnerability of vulnerabilities) {
            if (!loadedAdvisories.current.some(entry => entry.cid === vulnerability.cid)) {
                loadedAdvisories.current.push({
                    cid: vulnerability.cid, 
                    advisory: await downloadAdvisory(vulnerability.cid)
                });
            }
            vulnerability.advisory = loadedAdvisories.current.find(entry => entry.cid === vulnerability.cid).advisory;
            updatedVulnerabilities.push(vulnerability); 
        }
        setSelectedVulnerabilities([...updatedVulnerabilities]);
        stopLoading();
    }

    /**
     * Maps a vendor address to a vendor name from the whitelist.
     * @param {string} address of the vendor to get the name of.
     * @returns string name of the vendor.
     */
    function mapAddressToVendorName(address) {
        let name = whitelist.map((e) => {
            if (e.address === address)
                return e.name;
            return "Unknown vendor"
        });
        return name;
    }

    /**
     * Determines which storage system to use to download the advisory.
     * @param {string} path to the advisory from announcement event. 
     * @returns SecurityAdvisory object parsed from the advisory.
     */
    async function downloadAdvisory(path) {
        const storageSystem = path.split("/")[0];
        switch (storageSystem) {
            case "ipfs":
                return await loadIpfsContent(path.split("/")[1]);
            case "arweave":
                throw new Error("Arweave not yet supported.");
            default:
                return await loadIpfsContent(path); // when no storage system is specified, assume IPFS
        }
    }

    /**
     * Download an advisory from IPFS.
     * @param {string} cid 
     * @returns Parsed advisory.
     */
    async function loadIpfsContent(cid) {
        let content = [];
        for await (const chunk of await ipfs.cat(cid)) {
            content = [...content, ...chunk];
        }
        return new SecurityAdvisory(Buffer.from(content).toString('utf8'));
    }

    /**
     * Downloads the advisory as a CSAF file to the users computer.
     * @param {*} advisory 
     */
    const download = (advisory) => {
        console.log(advisory);
        const element = document.createElement("a");
        const file = new Blob([JSON.stringify(advisory)], {type: 'application/json'});
        element.href = URL.createObjectURL(file);
        element.download = advisory.title + ".json";
        document.body.appendChild(element);
        element.click();
    }

    return (
        <Accordion>
            {vulnerabilities.map((vulnerability, index) =>
                <Accordion.Item key={index} eventKey={index}>
                    <Accordion.Header>
                        <Container>
                            <Row>
                                <Col xs lg="2"><Badge pill bg="dark">{vulnerability[0].advisory.severity}</Badge></Col>
                                <Col xs lg="2">{vulnerability[0].event.returnValues.advisoryIdentifier}</Col>
                                <Col xs lg="4">{mapAddressToVendorName(vulnerability[0].tx.to)}</Col>
                                <Col xs lg="3">{new Date(vulnerability[0].block.timestamp * 1000).toLocaleString('en-GB')}</Col>
                            </Row>
                        </Container>
                    </Accordion.Header>
                    <Accordion.Body onEnter={() => {startLoading(); selectVulnerabilities(vulnerability)}}>
                        {loading === false 
                            ?   <div><p>Use the tabs below to select a specific version of the advisory to get information from.</p>
                                    <Tabs>
                                        { selectedVulnerabilities.map((version, index) => 
                                            <Tab key={index} eventKey={"VulnerabilityDetails" + index} 
                                                title={"version " + index}>
                                                <br></br>
                                                <Row>
                                                    <Col lg="10">
                                                        <h2>{version.advisory.title}</h2>
                                                    </Col>
                                                    <Col lg="2">
                                                        <Button onClick={() => download(version.advisory)}>Download CSAF</Button>
                                                    </Col>
                                                </Row>
                                                <hr></hr>
                                                <h3>{version.advisory.description}</h3>
                                                <br />
                                                {dependencies !== []
                                                    ? <VulnerabilityDetails
                                                        advisory={version.advisory} 
                                                        dependencies={dependencies}
                                                        vulnerabilityIds={version.event.returnValues.vulnerabilityIdentifiers.split(",")}/>
                                                    : <h5>Cannot show because of missing dependency information.</h5>
                                                }
                                            </Tab>
                                        )}
                                    </Tabs>
                                </div>
                            :   <Spinner animation="border" role="status"  style={{ width: "4rem", height: "4rem" }}>
                                    <span className="visually-hidden">Loading...</span>
                                </Spinner>
                        }
                    </Accordion.Body>
                </Accordion.Item>
            )}
        </Accordion>
    )
}
export default VulnerabilityAccordion;